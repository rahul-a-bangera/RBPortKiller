name: Build and Release

on:
  push:
    branches:
      - master
    paths:
      - 'RBPortKiller.CLI/RBPortKiller.CLI.csproj'

permissions:
  contents: write

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'RBPortKiller.CLI/RBPortKiller.CLI.csproj'
  
jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      version-changed: ${{ steps.check-tag.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Get version from csproj
        id: get-version
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' RBPortKiller.CLI/RBPortKiller.CLI.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
          
      - name: Check if version tag exists
        id: check-tag
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          git fetch --tags
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Tag v$VERSION already exists. Skipping release."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "New version detected: v$VERSION"
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.version-changed == 'true'
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Restore dependencies
        run: dotnet restore
        
      - name: Build
        run: dotnet build --configuration Release --no-restore
        
      - name: Run tests
        run: dotnet test --no-restore --verbosity normal
        continue-on-error: true
          
      - name: Publish Windows x64
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o ./publish/win-x64
          
      - name: Publish Windows x86
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r win-x86 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o ./publish/win-x86
        
      - name: Create ZIP Archives
        run: |
          Compress-Archive -Path .\publish\win-x64\* -DestinationPath .\rbportkiller-win-x64.zip
          Compress-Archive -Path .\publish\win-x86\* -DestinationPath .\rbportkiller-win-x86.zip
          
      - name: Calculate checksums
        id: checksums
        run: |
          $checksums = @()
          
          $files = @(
            "rbportkiller-win-x64.zip",
            "rbportkiller-win-x86.zip"
          )
          
          foreach ($file in $files) {
            $hash = (Get-FileHash $file -Algorithm SHA256).Hash
            $checksums += "$file`: $hash"
          }
          
          $checksums -join "`n" | Out-File -FilePath checksums.txt -Encoding utf8
          
      - name: Generate release notes
        run: |
          $version = "${{ needs.check-version.outputs.version }}"
          
          $checksums = Get-Content checksums.txt -Raw
          
          $notes = @"
          ## RBPortKiller v$version
          
          A Windows CLI tool for viewing and managing network ports and their associated processes.
          
          ### Downloads
          
          | Platform | Architecture | File |
          |----------|-------------|------|
          | Windows | x64 | ``rbportkiller-win-x64.zip`` |
          | Windows | x86 | ``rbportkiller-win-x86.zip`` |
          
          ### Installation
          
          **Windows:**
          ``````powershell
          Expand-Archive -Path rbportkiller-win-x64.zip -DestinationPath .\rbportkiller
          .\rbportkiller\rbportkiller.exe
          ``````
          
          ### What's New
          
          See the README.md for feature details and usage instructions
          
          ### Security Note
          
          This executable is not digitally signed. Windows may display a security warning on first run.
          - Right-click the file, select Properties, check "Unblock", then click Apply
          - Or click "More info" and "Run anyway" when prompted
          
          The source code is fully open source and available for review.
          
          ### Checksums (SHA256)
          
          ``````
          $checksums
          ``````
          
          ---
          
          **Full Changelog:** https://github.com/rahul-a-bangera/RBPortKiller/compare/v$version
          "@
          
          $notes | Out-File -FilePath release_notes.md -Encoding utf8
          
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: RBPortKiller v${{ needs.check-version.outputs.version }}
          body_path: release_notes.md
          files: |
            rbportkiller-win-x64.zip
            rbportkiller-win-x86.zip
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
