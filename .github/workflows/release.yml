name: Build and Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'RBPortKiller.CLI/RBPortKiller.CLI.csproj'
  
jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      version-changed: ${{ steps.check-tag.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: Get version from csproj
        id: get-version
        run: |
          VERSION=$(grep -oP '(?<=<Version>)[^<]+' RBPortKiller.CLI/RBPortKiller.CLI.csproj)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
          
      - name: Check if version tag exists
        id: check-tag
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          git fetch --tags
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Tag v$VERSION already exists. Skipping release."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "New version detected: v$VERSION"
          fi

  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Restore dependencies
        run: dotnet restore
        
      - name: Build
        run: dotnet build --configuration Release --no-restore
        
      - name: Run tests
        run: dotnet test --no-restore --verbosity normal
        continue-on-error: true

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.version-changed == 'true'
    runs-on: windows-latest
    
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Publish Windows x64
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o ./publish/win-x64
          
      - name: Publish Windows x86
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r win-x86 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o ./publish/win-x86
        
      - name: Copy installation files
        run: |
          Copy-Item "RBPortKiller.CLI\install.bat" -Destination ".\publish\win-x64\"
          Copy-Item "RBPortKiller.CLI\README.txt" -Destination ".\publish\win-x64\"
          
          Copy-Item "RBPortKiller.CLI\install.bat" -Destination ".\publish\win-x86\"
          Copy-Item "RBPortKiller.CLI\README.txt" -Destination ".\publish\win-x86\"
        
      - name: Create ZIP Archives
        run: |
          Compress-Archive -Path .\publish\win-x64\* -DestinationPath .\rbportkiller-win-x64.zip
          Compress-Archive -Path .\publish\win-x86\* -DestinationPath .\rbportkiller-win-x86.zip
          
      - name: Calculate checksums
        id: checksums
        run: |
          $checksums = @()
          
          $files = @(
            "rbportkiller-win-x64.zip",
            "rbportkiller-win-x86.zip"
          )
          
          foreach ($file in $files) {
            $hash = (Get-FileHash $file -Algorithm SHA256).Hash
            $checksums += "$file`: $hash"
          }
          
          $checksums -join "`n" | Out-File -FilePath checksums.txt -Encoding utf8
          
      - name: Generate release notes
        run: |
          $version = "${{ needs.check-version.outputs.version }}"
          
          $notes = @"
          ## RBPortKiller v$version
          
          A cross-platform CLI tool for viewing and managing network ports and their associated processes.
          Built with .NET 8, featuring an intuitive interface for monitoring active connections and terminating port-blocking processes.
          
          ### Installation
          
          
          1. Download the appropriate ZIP file for your system from the Assets section below
          2. Extract the ZIP file to your desired location
          3. Double-click: ``install.bat``
             - For system-wide install: Right-click ``install.bat`` > "Run as Administrator"
          4. Open a NEW Command Prompt or PowerShell
          5. Type ``rbportkiller`` from any directory to launch the tool
          
          **Manual**: Run ``rbportkiller.exe`` directly or add the folder to your PATH. See ``README.txt`` for details.
          "@
          
          $notes | Out-File -FilePath release_notes.md -Encoding utf8
          
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: RBPortKiller v${{ needs.check-version.outputs.version }}
          body_path: release_notes.md
          files: |
            rbportkiller-win-x64.zip
            rbportkiller-win-x86.zip
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
